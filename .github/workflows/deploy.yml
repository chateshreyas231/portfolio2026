name: Deploy to Firebase & Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: portfolio2024-b95ee
  REGION: us-central1
  SERVICE_NAME: portfolio-app
  # Artifact Registry format: {REGION}-docker.pkg.dev
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: false

      - name: Build Next.js application
        env:
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NODE_ENV: production
        run: |
          echo "üî® Building Next.js application..."
          npm run build
          echo "‚úÖ Build completed successfully"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Verify Google Cloud authentication
        run: |
          echo "üîê Verifying Google Cloud authentication..."
          gcloud auth list
          gcloud config get-value project
          
      - name: Check service account permissions
        run: |
          echo "üîç Checking service account permissions..."
          CURRENT_SA=$(gcloud auth list --filter=status:ACTIVE --format="value(account)")
          echo "Active service account: $CURRENT_SA"
          
          echo "Checking IAM permissions for Artifact Registry..."
          gcloud projects get-iam-policy ${{ env.PROJECT_ID }} \
            --flatten="bindings[].members" \
            --filter="bindings.members:$CURRENT_SA" \
            --format="table(bindings.role)" || echo "‚ö†Ô∏è Could not list IAM policies"
          
          echo "‚úÖ Permission check completed"

      - name: Enable required APIs
        run: |
          echo "üîß Enabling required Google Cloud APIs..."
          gcloud services enable artifactregistry.googleapis.com --project=${{ env.PROJECT_ID }} || echo "‚ö†Ô∏è Artifact Registry API may already be enabled"
          gcloud services enable cloudbuild.googleapis.com --project=${{ env.PROJECT_ID }} || echo "‚ö†Ô∏è Cloud Build API may already be enabled"
          gcloud services enable run.googleapis.com --project=${{ env.PROJECT_ID }} || echo "‚ö†Ô∏è Cloud Run API may already be enabled"
          gcloud services enable secretmanager.googleapis.com --project=${{ env.PROJECT_ID }} || echo "‚ö†Ô∏è Secret Manager API may already be enabled"
          echo "‚úÖ APIs enabled"

      - name: Create Artifact Registry repository
        id: create-repo
        run: |
          echo "üì¶ Checking Artifact Registry repository..."
          set +e  # Don't exit on error for the check
          REPO_EXISTS=$(gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} 2>&1)
          REPO_CHECK_EXIT=$?
          set -e  # Exit on error again
          
          if [ $REPO_CHECK_EXIT -eq 0 ]; then
            echo "‚úÖ Repository already exists"
            echo "$REPO_EXISTS"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "üì¶ Repository does not exist. Creating Artifact Registry repository..."
            echo "Repository name: ${{ env.SERVICE_NAME }}"
            echo "Location: ${{ env.REGION }}"
            echo "Project: ${{ env.PROJECT_ID }}"
            
            # Create repository with explicit error handling
            if gcloud artifacts repositories create ${{ env.SERVICE_NAME }} \
              --repository-format=docker \
              --location=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --description="Docker repository for portfolio app"; then
              echo "‚úÖ Repository created successfully"
              echo "exists=false" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Failed to create repository"
              echo "Checking if repository was created by another process..."
              sleep 5
              # Check again after a short wait
              if gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
                --location=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }} 2>/dev/null; then
                echo "‚úÖ Repository exists now (may have been created concurrently)"
                echo "exists=true" >> $GITHUB_OUTPUT
              else
                echo "‚ùå Repository creation failed and repository does not exist"
                exit 1
              fi
            fi
          fi

      - name: Verify Artifact Registry repository
        run: |
          echo "üîç Verifying repository access..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
              --location=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} 2>/dev/null; then
              echo "‚úÖ Repository verified and accessible"
              gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
                --location=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }}
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Repository not accessible yet, waiting... ($RETRY_COUNT/$MAX_RETRIES)"
                sleep 5
              else
                echo "‚ùå Repository verification failed after $MAX_RETRIES attempts"
                echo "Repository may not exist or service account lacks permissions"
                exit 1
              fi
            fi
          done

      - name: Configure Docker for Artifact Registry
        run: |
          echo "üê≥ Configuring Docker authentication..."
          # Get the actual registry URI from the repository
          REGISTRY_URI=$(gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(name)' 2>/dev/null | sed 's|projects/.*/locations/\(.*\)/repositories/.*|\1-docker.pkg.dev|' || echo "${{ env.REGION }}-docker.pkg.dev")
          
          if [ -z "$REGISTRY_URI" ] || [ "$REGISTRY_URI" == "docker.pkg.dev" ]; then
            REGISTRY_URI="${{ env.REGION }}-docker.pkg.dev"
          fi
          
          echo "Configuring Docker for: $REGISTRY_URI"
          gcloud auth configure-docker $REGISTRY_URI --quiet
          echo "‚úÖ Docker configured for $REGISTRY_URI"

      - name: Get Artifact Registry URI
        id: get-registry-uri
        run: |
          echo "üîç Getting Artifact Registry URI..."
          REGISTRY_URI=$(gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(name)' 2>/dev/null | sed 's|projects/.*/locations/\(.*\)/repositories/.*|\1-docker.pkg.dev|' || echo "${{ env.REGION }}-docker.pkg.dev")
          
          # Fallback to region-based format if URI extraction fails
          if [ -z "$REGISTRY_URI" ] || [ "$REGISTRY_URI" == "docker.pkg.dev" ]; then
            REGISTRY_URI="${{ env.REGION }}-docker.pkg.dev"
          fi
          
          echo "registry=$REGISTRY_URI" >> $GITHUB_OUTPUT
          echo "‚úÖ Registry URI: $REGISTRY_URI"

      - name: Build Docker image
        id: build-image
        run: |
          echo "üî® Building Docker image..."
          REGISTRY="${{ steps.get-registry-uri.outputs.registry }}"
          IMAGE_TAG="$REGISTRY/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          LATEST_TAG="$REGISTRY/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:latest"
          
          echo "Registry: $REGISTRY"
          echo "Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" -t "$LATEST_TAG" .
          
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Docker image built successfully"

      - name: Verify repository before push
        id: verify-repo
        run: |
          echo "üîç Final verification of repository before push..."
          REPO_NAME="${{ env.SERVICE_NAME }}"
          
          # Get the actual registry URI
          REGISTRY_URI=$(gcloud artifacts repositories describe $REPO_NAME \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format='value(name)' 2>/dev/null | sed 's|projects/.*/locations/\(.*\)/repositories/.*|\1-docker.pkg.dev|' || echo "${{ env.REGION }}-docker.pkg.dev")
          
          if [ -z "$REGISTRY_URI" ] || [ "$REGISTRY_URI" == "docker.pkg.dev" ]; then
            REGISTRY_URI="${{ env.REGION }}-docker.pkg.dev"
          fi
          
          REPO_PATH="$REGISTRY_URI/${{ env.PROJECT_ID }}/$REPO_NAME/$REPO_NAME"
          
          echo "Registry URI: $REGISTRY_URI"
          echo "Repository path: $REPO_PATH"
          
          # Verify repository exists
          if ! gcloud artifacts repositories describe $REPO_NAME \
            --location=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} 2>/dev/null; then
            echo "‚ùå Repository $REPO_NAME does not exist!"
            echo "Attempting to list all repositories..."
            gcloud artifacts repositories list --location=${{ env.REGION }} --project=${{ env.PROJECT_ID }} || true
            exit 1
          fi
          
          echo "registry=$REGISTRY_URI" >> $GITHUB_OUTPUT
          echo "‚úÖ Repository confirmed to exist at $REGISTRY_URI"

      - name: Push Docker image to Artifact Registry
        id: push-image
        run: |
          echo "üì§ Pushing Docker image to Artifact Registry..."
          
          # Use the registry URI from verification step or fallback
          REGISTRY="${{ steps.verify-repo.outputs.registry }}"
          if [ -z "$REGISTRY" ]; then
            REGISTRY="${{ env.REGION }}-docker.pkg.dev"
          fi
          
          IMAGE_TAG="$REGISTRY/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          LATEST_TAG="$REGISTRY/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:latest"
          
          echo "Using registry: $REGISTRY"
          echo "Pushing image: $IMAGE_TAG"
          echo "Pushing latest: $LATEST_TAG"
          
          # Verify Docker is authenticated to the correct registry
          echo "üîê Verifying Docker authentication..."
          gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin $REGISTRY
          
          # Push with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            if docker push "$IMAGE_TAG" && docker push "$LATEST_TAG"; then
              echo "‚úÖ Images pushed successfully"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Push failed, retrying in 10 seconds ($RETRY_COUNT/$MAX_RETRIES)..."
                echo "Re-authenticating Docker..."
                gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin $REGISTRY
                sleep 10
              else
                echo "‚ùå Push failed after $MAX_RETRIES attempts"
                echo "Checking repository status..."
                gcloud artifacts repositories describe ${{ env.SERVICE_NAME }} \
                  --location=${{ env.REGION }} \
                  --project=${{ env.PROJECT_ID }} || echo "Repository check failed"
                exit 1
              fi
            fi
          done

      - name: Create or update Resend API key secret
        run: |
          echo "üîê Managing Resend API key secret..."
          if gcloud secrets describe resend-api-key --project=${{ env.PROJECT_ID }} 2>/dev/null; then
            echo "üìù Updating existing secret..."
            echo -n "${{ secrets.RESEND_API_KEY }}" | gcloud secrets versions add resend-api-key --data-file=- --project=${{ env.PROJECT_ID }}
            echo "‚úÖ Secret updated"
          else
            echo "üìù Creating new secret..."
            echo -n "${{ secrets.RESEND_API_KEY }}" | gcloud secrets create resend-api-key \
              --data-file=- \
              --project=${{ env.PROJECT_ID }} \
              --replication-policy="automatic"
            echo "‚úÖ Secret created"
          fi
          
          # Grant Cloud Run access to the secret
          echo "üîë Granting Cloud Run access to secret..."
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.PROJECT_ID }} --format='value(projectNumber)')
          gcloud secrets add-iam-policy-binding resend-api-key \
            --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
            --role="roles/secretmanager.secretAccessor" \
            --project=${{ env.PROJECT_ID }} \
            --quiet || echo "‚ö†Ô∏è IAM binding may already exist"

      - name: Deploy to Cloud Run
        id: deploy-cloud-run
        run: |
          echo "üöÄ Deploying to Cloud Run..."
          
          # Get the correct registry URI
          REGISTRY="${{ steps.verify-repo.outputs.registry }}"
          if [ -z "$REGISTRY" ]; then
            REGISTRY="${{ env.REGION }}-docker.pkg.dev"
          fi
          
          # Build the correct image tag using Artifact Registry
          IMAGE_TAG="$REGISTRY/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          
          echo "Deploying image: $IMAGE_TAG"
          echo "Registry: $REGISTRY"
          
          # Check if service exists and what image it's currently using
          if gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} 2>/dev/null; then
            echo "üìù Service exists, checking current configuration..."
            
            CURRENT_IMAGE=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --format='value(spec.template.spec.containers[0].image)')
            echo "Current image: $CURRENT_IMAGE"
            
            # Remove PORT env var if it exists (Cloud Run sets this automatically)
            gcloud run services update ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --remove-env-vars PORT \
              --quiet 2>/dev/null || echo "‚ö†Ô∏è PORT removal attempted (may not exist)"
            
            # Remove RESEND_API_KEY from env vars if it exists (we'll use secrets instead)
            gcloud run services update ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --remove-env-vars RESEND_API_KEY \
              --quiet 2>/dev/null || echo "‚ö†Ô∏è RESEND_API_KEY removal attempted (may not exist)"
          else
            echo "üìù Service does not exist, will create new service"
          fi
          
          # Deploy to Cloud Run with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Deployment attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            if gcloud run deploy ${{ env.SERVICE_NAME }} \
              --image "$IMAGE_TAG" \
              --platform managed \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --allow-unauthenticated \
              --min-instances 1 \
              --max-instances 10 \
              --memory 2Gi \
              --cpu 2 \
              --timeout 300 \
              --update-env-vars "NODE_ENV=production,CONTACT_EMAIL=connect@shreyaschate.dev,FROM_EMAIL=Portfolio Contact <onboarding@resend.dev>,NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }},NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
              --update-secrets "RESEND_API_KEY=resend-api-key:latest" \
              --port 8080 \
              --quiet; then
              echo "‚úÖ Cloud Run deployment successful"
              
              # Verify the deployed image
              DEPLOYED_IMAGE=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                --region=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }} \
                --format='value(spec.template.spec.containers[0].image)')
              echo "‚úÖ Deployed image: $DEPLOYED_IMAGE"
              
              # Verify RESEND_API_KEY is using secrets, not env vars
              ENV_VARS=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                --region=${{ env.REGION }} \
                --project=${{ env.PROJECT_ID }} \
                --format='value(spec.template.spec.containers[0].env[].name)' | grep -i resend || echo "none")
              
              if [ "$ENV_VARS" != "none" ]; then
                echo "‚ö†Ô∏è WARNING: RESEND_API_KEY found in environment variables. Should use secrets!"
              else
                echo "‚úÖ RESEND_API_KEY is using Secret Manager (secure)"
              fi
              
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 10 seconds ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 10
              else
                echo "‚ùå Deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Get Cloud Run service URL
        id: service-url
        run: |
          echo "üîç Retrieving Cloud Run service URL..."
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format 'value(status.url)')
          
          if [ -z "$SERVICE_URL" ]; then
            echo "‚ùå Failed to get service URL"
            exit 1
          fi
          
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Cloud Run service URL: $SERVICE_URL"

      - name: Verify Cloud Run deployment
        run: |
          echo "üîç Verifying Cloud Run deployment..."
          SERVICE_URL="${{ steps.service-url.outputs.url }}"
          
          # Wait for service to be ready
          echo "‚è≥ Waiting for service to be ready..."
          sleep 10
          
          # Check if service is responding
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/api/health" | grep -q "200\|404"; then
              echo "‚úÖ Service is responding"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Service not ready yet, waiting... ($RETRY_COUNT/$MAX_RETRIES)"
                sleep 10
              else
                echo "‚ö†Ô∏è Service may not be fully ready, but deployment completed"
              fi
            fi
          done

      - name: Install Firebase CLI
        run: |
          echo "üî• Installing Firebase CLI..."
          npm install -g firebase-tools
          firebase --version
          echo "‚úÖ Firebase CLI installed"

      - name: Authenticate to Firebase
        run: |
          echo "üîê Authenticating to Firebase..."
          echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login:ci --token
          echo "‚úÖ Firebase authentication successful"

      - name: Deploy to Firebase Hosting
        id: deploy-firebase
        run: |
          echo "üåê Deploying to Firebase Hosting..."
          firebase use ${{ env.PROJECT_ID }}
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if firebase deploy --only hosting --non-interactive; then
              echo "‚úÖ Firebase Hosting deployment successful"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è Firebase deployment failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 10
              else
                echo "‚ùå Firebase deployment failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Cloud Run Service:** ${{ steps.service-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
            echo "**Firebase Hosting:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üéâ Your portfolio is now live!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "üßπ Cleaning up on failure..."
          # Add any cleanup logic here if needed
          echo "Cleanup completed"
